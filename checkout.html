<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Checkout | Titan Mart BD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f5f5f5;}
.container{max-width:720px;margin:40px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.1);}
h2{text-align:center;color:#ff4c00;}
input,select{width:100%;padding:12px;margin:8px 0;border:1px solid #ccc;border-radius:8px;}
button{width:100%;padding:15px;background:#ff4c00;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;}
.product-img{width:100%;max-height:220px;object-fit:contain;border-radius:8px;margin-bottom:10px;}
.info{margin-bottom:10px;}
</style>
</head>
<body>

<div class="container">
<h2>Checkout</h2>

<img id="productImg" class="product-img" src="" alt="Product">
<div class="info"><b>Product:</b> <span id="product"></span></div>
<div class="info"><b>Price:</b> ৳<span id="price"></span></div>

<input id="name" placeholder="Your Name">
<input id="phone" placeholder="Phone Number">
<input id="address" placeholder="Full Address">

<div class="info">
<b>District:</b>
<input type="text" id="districtSearch" placeholder="Search District">
<select id="district"></select>
</div>

<div class="info">
<b>Thana/Upazila:</b>
<input type="text" id="thanaSearch" placeholder="Search Thana">
<select id="thana"></select>
</div>

<select id="qty">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
</select>

<div class="info"><b>Delivery Charge:</b> ৳<span id="delivery"></span></div>
<div class="info"><b>Total:</b> ৳<span id="total"></span></div>

<button onclick="placeOrder()">Place Order</button>
</div>

<script>
// Products from URL
const params = new URLSearchParams(window.location.search);
const product = params.get("product");
const price = parseInt(params.get("price"));
document.getElementById("product").innerText = product;
document.getElementById("price").innerText = price;
document.getElementById("productImg").src = product==="Arc Lighter"?"arc-lighter.jpg":"nose-hair-trimmer.jpg";

// Load districts & thana from JSON
let upazilaData = {};
fetch("bangladesh_upazilas.json").then(r=>r.json()).then(d=>{upazilaData=d; populateDistricts();});

// Populate districts
function populateDistricts(){
  const sel=document.getElementById("district");
  sel.innerHTML="";
  Object.keys(upazilaData).forEach(d=>{
    let o=document.createElement("option"); o.value=d; o.text=d; sel.add(o);
  });
  populateThana(); calc();
}

// Populate thana
function populateThana(){
  const sel=document.getElementById("thana");
  sel.innerHTML="";
  const dist=document.getElementById("district").value;
  (upazilaData[dist]||[]).forEach(t=>{
    let o=document.createElement("option"); o.value=t; o.text=t; sel.add(o);
  });
  calc();
}

// Delivery & total calculation
function calc(){
  const qty=parseInt(document.getElementById("qty").value);
  const dist=document.getElementById("district").value.trim();
  let delivery=120;
  if(dist==="Dhaka"||dist==="ঢাকা"){delivery=60;}
  document.getElementById("delivery").innerText=delivery;
  document.getElementById("total").innerText=price*qty+delivery;
}

document.getElementById("qty").onchange=calc;
document.getElementById("district").onchange=()=>{populateThana(); calc();};

// Search
document.getElementById("districtSearch").oninput=function(){
  const f=this.value.toLowerCase();
  const sel=document.getElementById("district"); sel.innerHTML="";
  Object.keys(upazilaData).filter(d=>d.toLowerCase().includes(f)).forEach(d=>{
    let o=document.createElement("option"); o.value=d; o.text=d; sel.add(o);
  });
  populateThana();
};
document.getElementById("thanaSearch").oninput=function(){
  const f=this.value.toLowerCase();
  const sel=document.getElementById("thana"); sel.innerHTML="";
  const dist=document.getElementById("district").value;
  (upazilaData[dist]||[]).filter(t=>t.toLowerCase().includes(f)).forEach(t=>{
    let o=document.createElement("option"); o.value=t; o.text=t; sel.add(o);
  });
};

// Unique Order ID
function orderID(){ return "TM"+Math.floor(100000+Math.random()*900000); }

// Place Order
function placeOrder(){
  const name=document.getElementById("name").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const address=document.getElementById("address").value.trim();
  const district=document.getElementById("district").value;
  const thana=document.getElementById("thana").value;
  const qty=parseInt(document.getElementById("qty").value);

  if(!name || !phone || !address){alert("Please fill all mandatory fields!"); return;}

  let delivery=120; if(district==="Dhaka"||district==="ঢাকা"){delivery=60;}
  const total=price*qty+delivery;
  const id=orderID();

  const now=new Date();
  const date=now.toLocaleDateString('en-GB'); // dd/mm/yyyy
  const time=now.toLocaleTimeString('en-GB',{hour12:false});

  const msg=`Order ID: ${id}
Date: ${date}
Time: ${time}
Name: ${name}
Phone: ${phone}
Address: ${address}
District: ${district}
Thana/Upazila: ${thana}
Product: ${product}
Quantity: ${qty}
Delivery Charge: ৳${delivery}
Total: ৳${total}`;

  // Open WhatsApp
  window.open("https://wa.me/8801980236917?text="+encodeURIComponent(msg), "_blank");

  // Send to Google Sheets
  fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec",{
    method:"POST",
    body:JSON.stringify({
      orderID:id,date:date,time:time,name:name,phone:phone,address:address,
      district:district,thana:thana,product:product,qty:qty,delivery:delivery,total:total
    })
  });
}
</script>
</body>
</html>
