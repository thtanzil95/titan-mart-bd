<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Checkout | Titan Mart BD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f5f5f5;}
.container{max-width:720px;margin:40px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
input,select{width:100%;padding:12px;margin-top:10px;border:1px solid #ccc;border-radius:8px;}
button{width:100%;padding:15px;margin-top:20px;background:#ff4c00;color:#fff;border:none;font-size:16px;border-radius:8px;cursor:pointer;}
.product-img{width:100%;max-height:160px;object-fit:contain;margin-top:10px;border-radius:10px;}
.item{border-bottom:1px solid #ccc;margin-bottom:10px;padding-bottom:10px;}
</style>
</head>
<body>

<div class="container">
  <h2>Checkout</h2>
  <input id="name" placeholder="Your Name">
  <input id="phone" placeholder="Phone Number">
  <input id="address" placeholder="Full Address">

  <div>
    <b>District:</b>
    <input type="text" id="districtSearch" placeholder="Search district...">
    <select id="district"></select>
  </div>
  <div>
    <b>Thana/Upazila:</b>
    <input type="text" id="thanaSearch" placeholder="Search Thana/Upazila...">
    <select id="thana"></select>
  </div>

  <div id="cartProducts"></div>

  <div><b>Delivery Charge:</b> ৳ <span id="delivery">0</span></div>
  <div><b>Total:</b> ৳ <span id="total">0</span></div>

  <button onclick="placeOrder()">Place Order</button>
</div>

<script>
let upazilaData = {};
fetch("bangladesh_upazilas.json").then(r=>r.json()).then(d=>{upazilaData=d;populateDistricts();});

function populateDistricts(){
  const sel=document.getElementById("district");
  Object.keys(upazilaData).forEach(d=>{
    let o=document.createElement("option"); o.value=d; o.text=d; sel.add(o);
  });
  populateThana(); calc();
}

function populateThana(){
  const sel=document.getElementById("thana"); sel.innerHTML="";
  const dist=document.getElementById("district").value;
  (upazilaData[dist]||[]).forEach(t=>{
    let o=document.createElement("option"); o.value=t; o.text=t; sel.add(o);
  });
  calc();
}

// Load products from cart
let cart = JSON.parse(localStorage.getItem("checkoutCart")||"[]");
const container = document.getElementById("cartProducts");
function renderCart(){
  container.innerHTML="";
  cart.forEach(p=>{
    const div = document.createElement("div"); div.className="item";
    div.innerHTML=`<b>${p.name}</b><br>
      <img class="product-img" src="${p.image}"><br>
      Price: ৳ ${p.price} | Quantity: ${p.qty} | Subtotal: ৳ ${p.price*p.qty}`;
    container.appendChild(div);
  });
}
renderCart();

// Calculate total
function calc(){
  const dist=document.getElementById("district").value;
  let delivery = dist==="Dhaka"?60:120;
  document.getElementById("delivery").innerText=delivery;
  let total=cart.reduce((acc,p)=>acc+p.price*p.qty,0)+delivery;
  document.getElementById("total").innerText=total;
}

document.getElementById("district").onchange=()=>{populateThana();calc();};

// Place order
function orderID(){return "TM"+Math.floor(100000+Math.random()*900000);}
function placeOrder(){
  const name=document.getElementById("name").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const address=document.getElementById("address").value.trim();
  const district=document.getElementById("district").value;
  const thana=document.getElementById("thana").value;
  if(!name||!phone||!address){alert("Please fill name, phone and address!");return;}
  const delivery=district==="Dhaka"?60:120;
  const total=cart.reduce((acc,p)=>acc+p.price*p.qty,0)+delivery;
  const id=orderID();
  const now=new Date();
  const date=now.toLocaleDateString('en-US');
  const time=now.toLocaleTimeString('en-US',{hour12:false});

  let msg=`Order ID: ${id}\nDate: ${date}\nTime: ${time}\nName: ${name}\nPhone: ${phone}\nAddress: ${address}\nDistrict: ${district}\nThana: ${thana}\n`;
  cart.forEach(p=>{msg+=`Product: ${p.name} | Qty: ${p.qty} | Price: ৳${p.price}\n`;});
  msg+=`Delivery Charge: ৳${delivery}\nTotal: ৳${total}`;

  window.open("https://wa.me/8801980236917?text="+encodeURIComponent(msg),"_blank");
}
</script>
</body>
</html>
