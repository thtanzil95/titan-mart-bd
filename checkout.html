<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | Titan Mart</title>
<style>
body{font-family:Arial, background:#f7f7f7; padding:20px;}
form{max-width:550px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
input,select{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:5px;}
button{background:#ff4c00;color:white;padding:12px;border:none;border-radius:5px;cursor:pointer;font-size:16px;}
button:hover{background:#e24300;}
.total{font-weight:bold;font-size:18px;margin-top:10px;}
</style>
</head>
<body>

<h2 style="text-align:center;color:#ff4c00;">Checkout Page</h2>

<form id="checkoutForm">
  Name:<input id="name" type="text" required>
  Phone:<input id="phone" type="text" required>
  Alt Phone:<input id="altphone" type="text">

  District:
  <select id="district" onchange="loadUpazilas()" required>
    <option value="">Loading districts...</option>
  </select>

  Thana/Upazila:
  <select id="thana" required>
    <option value="">Select district first</option>
  </select>

  Address:<input id="address" type="text" required>

  Product:
  <select id="product" onchange="updateTotal()">
    <option value="850">Arc Lighter</option>
    <option value="840">Nose Hair Trimmer</option>
  </select>

  Quantity:<input id="qty" type="number" value="1" min="1" onchange="updateTotal()">

  Delivery Charge: <span id="deliveryCharge">0</span> Taka
  <div class="total">Total: <span id="total">0</span> Taka</div>

  <button type="button" onclick="sendOrder()">Place Order</button>
</form>

<script>
// Load all districts from API
async function loadDistricts(){
  const res = await fetch("https://bdopenapi.vercel.app/api/geo/districts");
  const data = await res.json();
  const distEl = document.getElementById("district");
  distEl.innerHTML = '<option value="">Select District</option>';
  data.forEach(d => {
    let opt = document.createElement("option");
    opt.value = d.name;
    opt.textContent = d.name;
    distEl.appendChild(opt);
  });
}
loadDistricts();

// Load upazilas for selected district
async function loadUpazilas(){
  const dist = document.getElementById("district").value;
  if(!dist) return;
  const thanaEl = document.getElementById("thana");
  thanaEl.innerHTML = '<option value="">Loading upazilas...</option>';

  const res = await fetch(`https://bdopenapi.vercel.app/api/geo/upazilas?district=${encodeURIComponent(dist)}`);
  const data = await res.json();
  thanaEl.innerHTML = '<option value="">Select Thana</option>';
  data.forEach(u => {
    let opt = document.createElement("option");
    opt.value = u.name;
    opt.textContent = u.name;
    thanaEl.appendChild(opt);
  });

  // Delivery charge logic
  let charge = (dist === "Dhaka") ? 60 : 120;
  document.getElementById("deliveryCharge").innerText = charge;
  updateTotal();
}

// Total calculation
function updateTotal(){
  let p = parseInt(document.getElementById("product").value);
  let q = parseInt(document.getElementById("qty").value);
  let d = parseInt(document.getElementById("deliveryCharge").innerText);
  document.getElementById("total").innerText = (p * q) + d;
}

// Send order
function sendOrder(){
  let name = document.getElementById("name").value;
  let phone = document.getElementById("phone").value;
  let altphone = document.getElementById("altphone").value;
  let district = document.getElementById("district").value;
  let thana = document.getElementById("thana").value;
  let address = document.getElementById("address").value;
  let productText = document.getElementById("product").options[document.getElementById("product").selectedIndex].text;
  let qty = document.getElementById("qty").value;
  let total = document.getElementById("total").innerText;
  let deliveryCharge = document.getElementById("deliveryCharge").innerText;

  if(!name || !phone || !district || !thana || !address){
    alert("Please fill all required fields!");
    return;
  }

  let msg = encodeURIComponent(
    `üõí New Order\n\nüë§ Name: ${name}\nüìû Phone: ${phone}\nüìç District: ${district}\nüèò Thana: ${thana}\nüè† Address: ${address}\nüì¶ Product: ${productText}\nüî¢ Qty: ${qty}\nüöö Delivery: ${deliveryCharge} Taka\nüí∞ Total: ${total} Taka`
  );
  window.open("https://wa.me/8801980236917?text="+msg, "_blank");

  // Save to Google Sheet
  fetch("WEB_APP_URL_HERE", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      name, phone, altphone, district, thana, address,
      product: productText, qty, delivery: deliveryCharge, total
    })
  });

  if(confirm("WhatsApp ‡¶ñ‡ßÅ‡¶≤‡ßá‡¶õ‡ßá‡•§ Message ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶™‡¶∞ OK ‡¶ö‡¶æ‡¶™‡ßÅ‡¶® Success page ‡¶è ‡¶Ø‡ßá‡¶§‡ßá‡•§")){
    window.location.href="success.html";
  }
}

updateTotal();
</script>

</body>
</html>
